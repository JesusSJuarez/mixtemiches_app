{% extends 'bitacora/master.html' %}

{% block title %}Configuración del Sistema{% endblock %}

{% block content %}
<div class="p-4 sm:p-6 md:p-8 max-w-4xl mx-auto">
    <div class="bg-white rounded-xl p-6 shadow-lg border border-gray-200">
        
        <div class="mb-6 pb-4 border-b border-gray-200">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">
                <i class="fas fa-cog mr-3 text-yellow-500"></i>Configuración del Sistema
            </h1>
        </div>

        {% if messages %}
            {% for message in messages %}
                <div class="mb-4 p-4 text-sm rounded-lg {% if message.tags == 'success' %}bg-green-100 text-green-700{% elif message.tags == 'error' %}bg-red-100 text-red-700{% else %}bg-blue-100 text-blue-700{% endif %}" role="alert">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}

        <!-- 
          INICIO DEL FORMULARIO PRINCIPAL
        -->
        <form method="post" action="{% url 'bitacora:configuracion' %}" class="space-y-6">
            {% csrf_token %}
            
            <!-- Sección de Tolerancia -->
            <div class="p-5 border border-gray-200 rounded-lg">
                <h2 class="text-lg font-semibold text-gray-700 mb-3">Asistencia</h2>
                <div>
                    <label for="{{ form.minutos_tolerancia_entrada.id_for_label }}" class="block mb-2 text-sm font-medium text-gray-900">Minutos de tolerancia para retardo</label>
                    {{ form.minutos_tolerancia_entrada }}
                    {% if form.minutos_tolerancia_entrada.help_text %}
                    <p class="mt-2 text-xs text-gray-500">{{ form.minutos_tolerancia_entrada.help_text }}</p>
                    {% endif %}
                </div>
            </div>

            <!-- SECCIÓN: Gestionar Administradores (Solo Título y Añadir) -->
            <div class="pt-6 border-t border-gray-200 space-y-6">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800">
                    <i class="fas fa-users-cog mr-3 text-yellow-500"></i>Gestionar Administradores
                </h2>

                <!-- Formulario de Añadir Administrador -->
                <div class="p-5 border border-gray-200 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Añadir Nuevo Administrador</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="{{ form.nuevo_admin_usuario.id_for_label }}" class="block mb-2 text-sm font-medium text-gray-900">Nombre de Usuario</label>
                            {{ form.nuevo_admin_usuario }}
                            {% if form.nuevo_admin_usuario.help_text %}
                            <p class="mt-2 text-xs text-gray-500">{{ form.nuevo_admin_usuario.help_text }}</p>
                            {% endif %}
                        </div>
                        <div>
                            <label for="{{ form.nuevo_admin_password.id_for_label }}" class="block mb-2 text-sm font-medium text-gray-900">Contraseña</label>
                            {{ form.nuevo_admin_password }}
                        </div>
                    </div>
                    {% if form.non_field_errors or form.nuevo_admin_usuario.errors or form.nuevo_admin_password.errors %}
                    <div class="mt-3 text-sm text-red-600">
                        {{ form.non_field_errors }}
                        {{ form.nuevo_admin_usuario.errors }}
                        {{ form.nuevo_admin_password.errors }}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Botón de Guardar (para el formulario principal) -->
            <div class="flex justify-end pt-4 border-t border-gray-200">
                <button type="submit" class="text-white bg-red-600 hover:bg-red-700 font-medium rounded-lg text-sm px-6 py-3 text-center">
                    <i class="fas fa-save mr-2"></i>Guardar Cambios
                </button>
            </div>
        </form>
        <!-- 
          FIN DEL FORMULARIO PRINCIPAL
        -->


        <!-- 
          INICIO DE SECCIÓN INDEPENDIENTE: LISTA DE ADMINS
        -->
        <div class="mt-8 pt-6 border-t border-gray-200">
            <h3 class="text-lg font-semibold text-gray-700 mb-3">Administradores Existentes</h3>
            <div class="overflow-x-auto rounded-lg border border-gray-200">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for admin in admins %}
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ admin.username }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ admin.email|default:"N/A" }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ admin.get_full_name|default:"N/A" }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <div class="flex items-center justify-end space-x-3">
                                    <a href="{% url 'bitacora:editar_admin' admin.id %}" class="text-yellow-600 hover:text-yellow-900" title="Editar">
                                        <i class="fas fa-pencil-alt"></i>
                                    </a>
                                    
                                    {% if request.user.id != admin.id %}
                                    <!-- 
                                      CAMBIO: 
                                      1. El <form> ya no está aquí.
                                      2. El botón es 'type="button"' y tiene data-attributes.
                                    -->
                                    <button type="button" 
                                            class="text-red-600 hover:text-red-900 delete-admin-btn" 
                                            title="Eliminar"
                                            data-delete-url="{% url 'bitacora:eliminar_admin' admin.id %}"
                                            data-admin-name="{{ admin.username|escapejs }}">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                    {% else %}
                                    <!-- Deshabilitar eliminación del propio usuario -->
                                    <span class="text-gray-400 cursor-not-allowed" title="No puedes eliminar tu propia cuenta">
                                        <i class="fas fa-trash-alt"></i>
                                    </span>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No se encontraron administradores.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <!-- FIN DE SECCIÓN INDEPENDIENTE -->

    </div>
</div>


<!-- 
  INICIO: MODAL DE CONFIRMACIÓN 
  Añadido al final del bloque de contenido, siguiendo el patrón de reportes.html 
-->
<div id="delete-admin-modal" class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-xl p-8 shadow-2xl text-center relative w-11/12 max-w-md transform transition-all scale-95 opacity-0">
        <h3 class="text-xl text-gray-800 font-bold mb-2">¿Estás seguro?</h3>
        <p class="text-gray-600 mb-6">
            Vas a eliminar permanentemente al administrador <strong id="delete-admin-name" class="font-bold"></strong>. Esta acción no se puede deshacer.
        </p>
        <!-- El formulario está DENTRO del modal -->
        <form id="delete-admin-form" method="POST" action="">
            {% csrf_token %}
            <div class="flex justify-center gap-4">
                <button type="button" id="cancel-delete-admin-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg transition">Cancelar</button>
                <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition">Confirmar Eliminación</button>
            </div>
        </form>
    </div>
</div>
<!-- FIN: MODAL DE CONFIRMACIÓN -->


<!-- 
  INICIO: SCRIPT DEL MODAL 
  Añadido al final del bloque de contenido, siguiendo el patrón de reportes.html 
-->
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Lógica para Modal de Eliminación de Admin ---
    const deleteModal = { 
        el: document.getElementById('delete-admin-modal'), 
        content: document.getElementById('delete-admin-modal')?.querySelector('.transform') 
    };

    const openModal = (modal) => {
        if (!modal.el) return;
        modal.el.classList.remove('hidden');
        setTimeout(() => { 
            modal.content.style.transform = 'scale(1)'; 
            modal.content.style.opacity = '1'; 
        }, 50);
    };

    const closeModal = (modal) => {
        if (!modal.el) return;
        modal.content.style.transform = 'scale(0.95)'; 
        modal.content.style.opacity = '0';
        setTimeout(() => modal.el.classList.add('hidden'), 200);
    };

    // Busca botones con la clase .delete-admin-btn
    document.querySelectorAll('.delete-admin-btn').forEach(button => {
        button.addEventListener('click', () => {
            // Configura la acción del formulario del modal y el texto
            document.getElementById('delete-admin-form').action = button.dataset.deleteUrl;
            document.getElementById('delete-admin-name').textContent = button.dataset.adminName;
            // Abre el modal
            openModal(deleteModal);
        });
    });

    // Botón de cancelar
    document.getElementById('cancel-delete-admin-btn')?.addEventListener('click', () => closeModal(deleteModal));
    
    // Clic en el fondo
    deleteModal.el?.addEventListener('click', e => { 
        if (e.target === deleteModal.el) closeModal(deleteModal); 
    });
    
    // Tecla Escape
    document.addEventListener('keydown', e => {
        if (e.key === "Escape" && !deleteModal.el?.classList.contains('hidden')) {
            closeModal(deleteModal);
        }
    });
});
</script>
<!-- FIN: SCRIPT DEL MODAL -->

{% endblock %}